import { GoogleGenAI, Chat } from "@google/genai";
import { AnalysisResult, Language, Market, AnalysisMode } from "../types";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const MARKET_CONFIG = {
  en: {
    'A_SHARE': 'A-Share (Chinese Stock Market)',
    'US_STOCK': 'US Stock Market (NASDAQ/NYSE)',
    'HK_STOCK': 'Hong Kong Stock Market (HKEX)'
  },
  zh: {
    'A_SHARE': 'Aè‚¡å¸‚åœº',
    'US_STOCK': 'ç¾è‚¡å¸‚åœº (çº³æ–¯è¾¾å…‹/çº½äº¤æ‰€)',
    'HK_STOCK': 'æ¸¯è‚¡å¸‚åœº'
  }
};

export interface ChatSessionResult {
  analysis: AnalysisResult;
  chat: Chat;
}

export const startStockChat = async (stockCode: string, market: Market, lang: Language, mode: AnalysisMode): Promise<ChatSessionResult> => {
  const modelId = "gemini-2.5-flash";
  const marketName = MARKET_CONFIG[lang][market];
  
  // Get current date
  const now = new Date();
  const dateStr = now.toLocaleDateString(lang === 'en' ? 'en-US' : 'zh-CN', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });

  // Base Identity
  let systemInstruction = lang === 'en' 
    ? `Act as a senior ${marketName} Quantitative Analyst. Today is ${dateStr}. `
    : `æ‰®æ¼”ä¸€ä½èµ„æ·±${marketName}é‡åŒ–åˆ†æå¸ˆã€‚ä»Šå¤©æ˜¯ ${dateStr}ã€‚`;

  // Mode Specific Instructions
  if (mode === 'LIVE') {
    systemInstruction += lang === 'en'
      ? `MODE: LIVE INTRADAY. Priority: Find the absolute LATEST REAL-TIME price. Technical indicators (MA/MACD) will be estimates based on the forming candle. Focus on intraday momentum and immediate action.`
      : `å½“å‰æ¨¡å¼: å®æ—¶ç›˜ä¸­ (LIVE)ã€‚ä¼˜å…ˆçº§: è·å–ç»å¯¹æœ€æ–°çš„**å®æ—¶è‚¡ä»·**ã€‚è¯·æ³¨æ„ä»Šå¤©çš„Kçº¿å°šæœªæ”¶ç›˜ï¼ŒæŠ€æœ¯æŒ‡æ ‡(MA/MACD)åŸºäºå½“å‰ä»·æ ¼ä¼°ç®—ã€‚é‡ç‚¹å…³æ³¨ç›˜ä¸­åŠ¨èƒ½å’Œå³æ—¶æ“ä½œã€‚`;
  } else {
    systemInstruction += lang === 'en'
      ? `MODE: SNAPSHOT (CLOSE). Priority: Analyze the LAST COMPLETED TRADING DAY (Closing Data). Ignore intraday noise if the market is open. Focus on precise, finalized technical indicators from the last close.`
      : `å½“å‰æ¨¡å¼: æ”¶ç›˜å¿«ç…§ (SNAPSHOT)ã€‚ä¼˜å…ˆçº§: åˆ†æ**ä¸Šä¸€ä¸ªå®Œæ•´äº¤æ˜“æ—¥**çš„æ”¶ç›˜æ•°æ®ã€‚å¦‚æœå½“å‰å·²å¼€ç›˜ï¼Œè¯·å¿½ç•¥ç›˜ä¸­æ³¢åŠ¨ï¼Œä¸“æ³¨äºåŸºäºç¡®å®šçš„æ”¶ç›˜ä»·è¿›è¡Œçš„ç²¾å‡†æŠ€æœ¯é¢å¤ç›˜ã€‚`;
  }

  // Initial Prompt Construction
  const modePromptEn = mode === 'LIVE' 
    ? `FETCH LIVE DATA: Search for "${stockCode} live price" and "${stockCode} intraday chart".`
    : `FETCH CLOSING DATA: Search for "${stockCode} closing price last trading day" and "${stockCode} historical data".`;

  const modePromptZh = mode === 'LIVE'
    ? `è·å–å®æ—¶æ•°æ®: æœç´¢ "${stockCode} å®æ—¶è‚¡ä»·" å’Œ "${stockCode} ä»Šæ—¥åˆ†æ—¶èµ°åŠ¿"ã€‚`
    : `è·å–æ”¶ç›˜æ•°æ®: æœç´¢ "${stockCode} æ˜¨æ—¥æ”¶ç›˜ä»·" æˆ– "${stockCode} ä¸Šä¸ªäº¤æ˜“æ—¥è¡Œæƒ…"ã€‚`;

  const initialPrompt = lang === 'en' ? `
    Target Stock: ${stockCode}
    Current Date: ${dateStr}
    Analysis Mode: ${mode}
    
    ACTION REQUIRED: ${modePromptEn}
    
    Please perform a comprehensive analysis using Search Grounding.
    
    You MUST structure your response strictly in Markdown format with the following sections:

    # ğŸ“Š QUANT REPORT: ${stockCode} (${mode === 'LIVE' ? 'Intraday' : 'Closing Snapshot'})

    ## 1. Market Data Snapshot
    (List Price, Change %, PE, Volume. **Explicitly state: "Data time: [Time/Date]"**.)

    ## 2. Technical Analysis
    (Analyze MA, MACD, KDJ, Bollinger Bands. If LIVE, mention these are dynamic.)

    ## 3. Fundamental News
    (Summarize the top 3 recent news items.)

    ## 4. Quantitative Strategy
    **Signal:** [BUY / SELL / HOLD / WAIT]
    **Confidence:** [0-100]%
    **Risk Level:** [Low / Medium / High]
    
    ## 5. Position Guidance
    (Specific instruction on position sizing.)

    ## 6. Execution Plan & Detailed Setup
    - **Primary Entry Zone:** (Specific price range)
    - **Aggressive/Alternative Entry:** (Breakout level)
    - **Hard Stop Loss:** (Specific price trigger)
    - **Take Profit Target 1:** (Conservative target)
    - **Take Profit Target 2:** (Extended target)
    - **Execution Logic:** (Context/Setup)

    *Disclaimer: This analysis is generated by AI for simulation purposes only.*
    ` : `
    ç›®æ ‡è‚¡ç¥¨ä»£ç : ${stockCode}
    å½“å‰æ—¥æœŸ: ${dateStr}
    åˆ†ææ¨¡å¼: ${mode === 'LIVE' ? 'å®æ—¶ç›˜ä¸­ (Live)' : 'æ”¶ç›˜å¿«ç…§ (Snapshot/Close)'}
    
    å…³é”®æŒ‡ä»¤: ${modePromptZh}
    
    è¯·åˆ©ç”¨å®æ—¶äº’è”ç½‘æ•°æ®ï¼ˆSearch Groundingï¼‰å¯¹è¯¥è‚¡ç¥¨è¿›è¡Œå…¨é¢åˆ†æã€‚
    
    ä½ å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ Markdown æ ¼å¼ç»„ç»‡ä½ çš„å›ç­”ï¼š

    # ğŸ“Š é‡åŒ–åˆ†ææŠ¥å‘Š: ${stockCode} (${mode === 'LIVE' ? 'å®æ—¶ç›˜ä¸­' : 'æ”¶ç›˜å¤ç›˜'})

    ## 1. å¸‚åœºæ•°æ®å¿«ç…§
    (åˆ—å‡ºä»·æ ¼, æ¶¨è·Œå¹…, PE, æˆäº¤é‡ã€‚**å¿…é¡»æ˜ç¡®æ ‡æ³¨: "æ•°æ®æ—¶é—´: [å…·ä½“æ—¶é—´/æ—¥æœŸ]"**ã€‚å¦‚æœæ˜¯LIVEæ¨¡å¼ï¼Œå¼ºè°ƒæ˜¯å½“å‰ä»·æ ¼ï¼›å¦‚æœæ˜¯SNAPSHOTæ¨¡å¼ï¼Œå¼ºè°ƒæ˜¯æ”¶ç›˜ä»·ã€‚)

    ## 2. æŠ€æœ¯é¢åˆ†æ
    (åˆ†æå‡çº¿ MA, MACD, KDJ, å¸ƒæ—å¸¦ã€‚**é‡è¦: å¦‚æœæ˜¯LIVEæ¨¡å¼ï¼Œè¯·æ³¨æ˜æŒ‡æ ‡éšè‚¡ä»·å˜åŠ¨ï¼›å¦‚æœæ˜¯SNAPSHOTæ¨¡å¼ï¼ŒåŸºäºç¡®å®šçš„æ”¶ç›˜ä»·åˆ†æã€‚**)

    ## 3. åŸºæœ¬é¢æ¶ˆæ¯
    (æ€»ç»“å½±å“è¯¥è‚¡ç¥¨çš„å‰3æ¡è¿‘æœŸæ–°é—»æˆ–å…¬å‘Šã€‚)

    ## 4. é‡åŒ–ç­–ç•¥
    **ä¿¡å·:** [ä¹°å…¥ / å–å‡º / æŒæœ‰ / è§‚æœ›]
    **ç½®ä¿¡åº¦:** [0-100]%
    **é£é™©ç­‰çº§:** [ä½ / ä¸­ / é«˜]
    
    ## 5. ä»“ä½æŒ‡å¯¼
    (å…·ä½“çš„ä»“ä½ç®¡ç†å»ºè®®ã€‚)

    ## 6. ç²¾ç»†åŒ–äº¤æ˜“æ‰§è¡Œè®¡åˆ’
    - **æ ¸å¿ƒå»ºä»“åŒºé—´:** (é«˜èƒœç‡ä»·æ ¼å¸¦)
    - **æ¿€è¿›/å¤‡é€‰ç­–ç•¥:** (å¦‚çªç ´å…³é”®ä½è¿½æ¶¨)
    - **åˆšæ€§æ­¢æŸä½:** (æ˜ç¡®ä»·æ ¼)
    - **ç¬¬ä¸€æ­¢ç›ˆä½:** (ä¿å®ˆç›®æ ‡)
    - **ç¬¬äºŒæ­¢ç›ˆä½:** (åšå¼ˆä¸»å‡æµªçš„ç›®æ ‡ä»·æ ¼)
    - **æ“ä½œç»†èŠ‚:** (å¦‚ï¼š"åˆ†æ‰¹ä½å¸", "å°¾ç›˜ç¡®è®¤")

    *å…è´£å£°æ˜: æœ¬åˆ†æç”±AIç”Ÿæˆï¼Œä»…ç”¨äºæ¨¡æ‹Ÿï¼Œä¸æ„æˆå®é™…æŠ•èµ„å»ºè®®ã€‚*
    `;

  try {
    const chat = ai.chats.create({
      model: modelId,
      config: {
        tools: [{ googleSearch: {} }],
        temperature: 0.1, 
        systemInstruction: systemInstruction,
      },
    });

    const response = await chat.sendMessage({ message: initialPrompt });
    const text = response.text || (lang === 'en' ? "No analysis generated." : "æœªç”Ÿæˆåˆ†æç»“æœã€‚");
    
    const groundingChunks = response.candidates?.[0]?.groundingMetadata?.groundingChunks || [];
    const groundingSources = groundingChunks
      .map((chunk) => chunk.web)
      .filter((web) => web !== undefined) as Array<{ uri: string; title: string }>;

    return {
      analysis: {
        rawText: text,
        symbol: stockCode,
        timestamp: new Date().toLocaleTimeString(),
        groundingSources,
      },
      chat: chat
    };
  } catch (error) {
    console.error("Gemini Analysis Error:", error);
    const errorMsg = lang === 'en' 
      ? "Failed to analyze stock data. Please check the stock code and try again."
      : "åˆ†æè‚¡ç¥¨æ•°æ®å¤±è´¥ã€‚è¯·æ£€æŸ¥è‚¡ç¥¨ä»£ç å¹¶é‡è¯•ã€‚";
    throw new Error(errorMsg);
  }
};

export const sendFollowUpMessage = async (chat: Chat, message: string): Promise<string> => {
  try {
    const response = await chat.sendMessage({ message });
    return response.text;
  } catch (error) {
    console.error("Follow-up Error:", error);
    throw new Error("Failed to process follow-up message.");
  }
};